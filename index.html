<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>–ö–∞—Ä—Ç–∞ —Ä–∞–∑–≤–æ–¥–Ω—ã—Ö –º–æ—Å—Ç–æ–≤ üåâ</title>
    <script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet'/>
    <link rel="icon" href="https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/google/241/bridge-at-night_1f309.png">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        article {
            display: flex;
        }
        #map {
            width: 100%;
            height: calc( 100vh - 77px);
        }
        header {
            background: #fff;
            padding: 20px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px #00000021 solid;
        }
        @media only screen and (max-width: 600px) {
            header {
                flex-wrap: wrap;
                align-content: center;
                justify-content: center;
                text-align: center;
            }
        }
        header h1, header h2 {
            font-family: Arial;
            margin: 0;
            color: #353535;
            padding: 0;
        }


        header .buttons {

        }
        header .buttons button {
            background: white;
            border-radius: 50px;
            border: 2px #707070 solid;
            min-width: 38px;
            height: 38px;
            outline: none;
        }
        #aside {
            width:320px;
            height: calc( 100vh - 77px);
            background: #fff;
            z-index: 99999;
        }
        @media only screen and (max-width: 600px) {
            #aside {
                width: 0;
                height: 0;
            }
        }
        #marker-list {
            height: 100%;
            overflow-x: auto;
            margin:0;
            padding:0;
        }
        #marker-list li {
            font-family: Arial;
            padding:10px;
            margin:0;
            list-style-type:none;
        }
        #marker-list li .title{
            margin: 0;

        }
        #marker-list li .comment{
            margin: 0;
            font-size: 14px;
            color:#a8a8a8;
        }
        #marker-list li:hover {
            background:#eee;
        }

        .marker-title {
            font-size: 20px;
            margin-bottom: 7px;
        }
        .marker-description {
            font-size: 16px;
        }
        .marker-description b {
            color: #792ec0;
        }

    </style>
</head>
<body>
<header>
    <div class="buttons">
        <button onclick="setLanguage('ru')">RU</button>
        <button onclick="setLanguage('en')">EN</button>
        <button onclick="setLanguage('ch')">CH</button>
        <button onclick="animating()">animating</button>
    </div>


    <h1 onclick="animate()">–ö–∞—Ä—Ç–∞ —Ä–∞–∑–≤–æ–¥–Ω—ã—Ö –º–æ—Å—Ç–æ–≤</h1>

    <h2 id="current_time"></h2>

</header>

<article>
    <div id="map"></div>
    <aside id="aside">
        <ul id="marker-list"></ul>
    </aside>
</article>


<script>
    var bridges = [
        {
            title: {
                ru: "–î–≤–æ—Ä—Ü–æ–≤—ã–π",
                en: "Palace Bridge",
                ch: "ÂÆ´Âª∑Ê°•"
            },

            time: [
                {
                    start: "1:10",
                    end: "2:50"
                },
                {
                    start: "3:10",
                    end: "4:55"
                }
            ],
            link: "dvorczovyj",
            coordinates: [30.308306, 59.941057]
        },
        {
            title: {
                ru: "–¢—É—á–∫–æ–≤",
                en: "Tuchkov Bridge",
                ch: "ÊùúÂ•áÁßëÂ§´Ê°•"
            },
            time: [
                {
                    start: "2:00",
                    end: "2:55"
                },
                {
                    start: "3:35",
                    end: "4:55"
                }
            ],
            link: "tuchkov",
            coordinates: [30.285653, 59.949049]
        },
        {
            title: {
                ru: "–ë–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫–∏–π",
                en: "Blagoveschensky Bridge",
                ch: "Âú£ÊØçÈ¢ÜÊä•Ê°•"
            },
            time: [
                {
                    start: "1:25",
                    end: "2:45"
                },
                {
                    start: "3:10",
                    end: "5:00"
                }
            ],
            link: "tuchkov",
            coordinates: [30.289662, 59.934740]
        },
        {
            title: {
                ru: "–¢—Ä–æ–∏—Ü–∫–∏–π",
                en: "Troitsky Bridge",
                ch: "Âú£‰∏â‰∏ÄÊ°•"
            },
            time: [
                {
                    start: "1:20",
                    end: "4:50"
                }
            ],
            link: "troiczkij",
            coordinates: [30.327694, 59.948492]
        },
        {
            title: {
                ru: "–í–æ–ª–æ–¥–∞—Ä—Å–∫–∏–π",
                en: "Volodarsky Bridge",
                ch: "Ê≤ÉÊ¥õËææÂ∞îÊñØÂü∫Ê°•"
            },
            time: [
                {
                    start: "2:00",
                    end: "3:45"
                },
                {
                    start: "4:15",
                    end: "5:45"
                }
            ],
            link: "volodarskij",
            coordinates: [30.453343, 59.877725]
        },
        {
            title: {
                ru: "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ù–µ–≤—Å–∫–æ–≥–æ",
                en: "Alexander Nevsky Bridge",
                ch: "‰∫öÂéÜÂ±±Â§ßÊ∂ÖÂ§´ÊñØÂü∫Ê°•"
            },
            time: [
                {
                    start: "2:20",
                    end: "5:10"
                }
            ],
            link: "aleksandra-nevskogo",
            coordinates: [30.395668, 59.925834]
        },
        {
            title: {
                ru: "–ë–æ–ª—å—à–µ–æ—Ö—Ç–∏–Ω—Å–∫–∏–π",
                en: "Bolsheokhtinsky Bridge",
                ch: "Â§ßÂ••‰ΩïÂ°îÊ°•"
            },
            time: [
                {
                    start: "2:00",
                    end: "5:00"
                }
            ],
            link: "bolsheohtinskij-most",
            coordinates: [30.401778, 59.942669]
        },
        {
            title: {
                ru: "–õ–∏—Ç–µ–π–Ω—ã–π",
                en: "Liteyny Bridge",
                ch: "Âà©Êç∑‰ºäÂÜÖÊ°•"
            },
            time: [
                {
                    start: "1:40",
                    end: "4:45"
                }
            ],
            link: "litejnyj",
            coordinates: [30.349359, 59.951938]
        },
        {
            title: {
                ru: "–ë–∏—Ä–∂–µ–≤–æ–π",
                en: "Birzhevoy Bridge",
                ch: "‰∫§ÊòìÊâÄÊ°•"
            },
            time: [
                {
                    start: "2:00",
                    end: "4:55"
                }
            ],
            link: "birzhevoj",
            coordinates: [30.303376, 59.946187]
        },
        {
            title: {
                ru: "–°–∞–º–ø—Å–æ–Ω–∏–µ–≤—Å–∫–∏–π",
                en: "Sampsonievsky Bridge",
                ch: "Ëê®ÊÅ©ÊôÆÁ¥¢Â∞ºËÄ∂Â§´Ê°•"
            },
            time: [],
            link: "sampsonievskij",
            coordinates: [30.337335, 59.957995]
        },
        {
            title: {
                ru: "–ì—Ä–µ–Ω–∞–¥–µ—Ä—Å–∫–∏–π",
                en: "Grenadersky Bridge",
                ch: "ÊààÂàóÁ∫≥Á¢üÂ∞îÊñØÂü∫Ê°•"
            },
            time: [],
            link: "grenaderskij",
            coordinates: [30.334711, 59.968028]
        },
        {
            title: {
                ru: "–ö–∞–Ω—Ç–µ–º–∏—Ä–æ–≤—Å–∫–∏–π",
                en: "Kantemirovsky Bridge",
                ch: "ÂùéÊç∑Á±≥ÁΩóÂ§´Ê°•"
            },
            time: [],
            link: "kantemirovskij",
            coordinates: [30.321657, 59.978426]
        }
    ];

    var i18 = {
        close: {
            ru: "–†–∞–∑–≤–µ–¥—ë–Ω",
            en: "The bridge is close",
            ch: "ËøôÂ∫ßÊ°•ÊòØÂºÄÊîæÁöÑ"
        },
        mostotrest: {
            ru: "–°–∞–π—Ç –ú–æ—Å—Ç–æ—Ç—Ä–µ—Å—Ç–∞",
            en: "The Mostotrest website",
            ch: "Mostotrest"
        },
        will_open(minutes){
            return {
                ru: "–°–≤–µ–¥—ë—Ç—Å—è —á–µ—Ä–µ–∑ " + Math.abs(minutes) + " –º–∏–Ω",
                en: "The bridge will open in " + Math.abs(minutes) + " min",
                ch: "Ê°•Â∞ÜÂú®" + Math.abs(minutes) + " ÂàÜÈíüÂêéÂºÄÊîæ"
            }
        },
        will_close(minutes){
            return {
                ru: "–†–∞–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ " + Math.abs(minutes) + " –º–∏–Ω",
                en: "The bridge will close in " + Math.abs(minutes) + " min",
                ch: "Ê°•Â∞ÜÂú®" + Math.abs(minutes) + " ÂàÜÈíüÂêéÂÖ≥Èó≠"
            }
        }

    }

    var Time = moment();
    var myLayer, map;
    function initMap(){
        L.mapbox.accessToken = 'pk.eyJ1IjoiaWx1c2hpbnZhbnlhIiwiYSI6ImNrZGVvcmhmbzI5M2UyeXM4bHFlYmpnZmwifQ.fZxiJyYQDS_CxhEXoZIueg';

        map = L.mapbox.map('map')
            .setView([59.935446, 30.328063], 12)
            .addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/streets-v11'));

        myLayer = L.mapbox
            .featureLayer(generateFeatures())
            .addTo(map);

        generateUlist()
    }
    initMap()

    function generateUlist(){
        var markerList = document.getElementById('marker-list');
        markerList.innerHTML = "";

        myLayer.eachLayer(function(layer) {
            var item = markerList.appendChild(document.createElement('li'));
            var item_html = "";
                item_html += "<p class='title'>" + layer.toGeoJSON().properties.title + "</p>";
                item_html += "<p class='comment'>" + layer.toGeoJSON().properties.comment + "</p>";

            item.innerHTML = item_html;

            item.onclick = function() {
                layer.openPopup();
                map.panTo(layer.getLatLng());
            };

        });
    }
    function generateFeatures(){
        var features = bridges.map(function(bridge){
            var checkTime_obj = checkTime(bridge.time);

            var bridge_description = bridge.time.map(function(time_obj){

                var string_time = time_obj.start + " - " + time_obj.end;

                if( JSON.stringify(time_obj) === JSON.stringify(checkTime_obj.time_obj) ){
                    string_time = "<b>" + string_time + "</b>";
                }
                return string_time;
            }).join("<br>")

            bridge_description += "<br>";
            bridge_description += "<br>";
            // https://en.mostotrest-spb.ru//
            var lang_prefix = app_language !== "ru" ? app_language + "." : "";
            var link = "https://" + lang_prefix + "mostotrest-spb.ru/bridges/" + bridge.link;
            var a_wrap_link = "<a href='" + link + "' target='_blank'>–º–æ—Å—Ç –Ω–∞ —Å–∞–π—Ç–µ –ú–æ—Å—Ç–æ—Ç—Ä–µ—Å—Ç–∞</a>";

            bridge_description += a_wrap_link;

            // console.log(checkStatus)

            var feature_bridge = {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: bridge.coordinates
                },
                properties: {
                    title: bridge.title[app_language],
                    description: bridge_description,
                    comment: checkTime_obj.comment,
                    'marker-size': 'large',

                    'marker-color': checkTime_color(checkTime_obj.status),
                    'marker-symbol': [2,3].includes(checkTime_obj.status) ? 'roadblock' : ''

                }
            };

            return feature_bridge;
        });

        var geoJson = {
            type: 'Bridges_Collection',
            features: features
        };

        return geoJson;
    }

    function setGeoJSON(){
        var geoJson = generateFeatures();
        myLayer.setGeoJSON(geoJson);
        generateUlist()
    }
    setInterval(setGeoJSON, 30000)



    function getYandexTime(){
        fetch("current_time.php")
            .then(response => response.json())
            .then(function(data ){
                // console.log( "2" )
                Time = moment(data.time).utc().utcOffset(3);
                setInterval(function(){
                    var current_sec = Time.seconds();
                    Time = Time.seconds(++current_sec);
                }, 1000)
            })
            .catch(function(e){

            })
            .finally(function(){
                setInterval(()=>{
                    var current_sec = getMomentNowTime().seconds();
                    var format_string =  "";
                    if(current_sec % 2){
                        format_string =  "HH  mm";
                    }else{
                        format_string =  "HH:mm";
                    }
                    var current_time = getMomentNowTime().utc().utcOffset(3).format(format_string);
                    // console.log(current_time)
                    document.getElementById("current_time").innerHTML = current_time;
                },1000)
            })
    };
    getYandexTime()

    function checkTime(time_array) {

        // 0 —Å–≤–µ–¥—ë–Ω
        // 1 —Å–∫–æ—Ä–æ —Ä–∞–∑–≤–µ–¥—ë—Ç—Å—è
        // 2 —Ä–∞–∑–≤–µ–¥—ë–Ω
        // 3 —Å–∫–æ—Ä–æ —Å–≤–µ–¥—ë—Ç—Å—è

        // time_array: [
        //     {
        //         start: "1:25",
        //         end: "2:45"
        //     },
        //     {
        //         start: "3:10",
        //         end: "5:00"
        //     }
        // ]
        var result = {
            status: 0, // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–µ–¥—ë–Ω
            time_obj: {},
            comment: ""
        };

        time_array.every(function(time_obj){
            var obj = {
                start: "",
                end: ""
            };

            for( let [key, value] of Object.entries(time_obj) ){
                // start: "1:45"

                let regex = /([0-9]*):([0-9]*)/g;
                let match = regex.exec(value);
                let hour = match[1];
                let minute = match[2];

                obj[key] = getMomentNowTime().hour(parseInt(hour)).minute(parseInt(minute));

            }

            var start = obj.start;
            var end = obj.end;

            if (getMomentNowTime().isBetween(start, end, undefined, '[)')){
                // –†–∞–∑–≤–µ–¥—ë–Ω
                result.status = 2;
                result.time_obj = time_obj;
                result.comment = i18.close[app_language];

                var to_end = getMomentNowTime().diff(end, 'minutes');
                if( to_end >= -15 && to_end <= 0){
                    // –ù–æ —Å–∫–æ—Ä–æ, –∞ –∏–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç, —Å–≤–æ–¥–∏—Ç—Å—è
                    result.status = 3;
                    result.time_obj = time_obj;
                    result.comment = i18.will_open(to_end)[app_language];
                    return false;
                }
                return false;
            }else{
                // –∑–¥–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞  –∏–ª–∏ —Å–∫–æ—Ä–æ —Å–≤–µ–¥–µ—Ç—Å—è 1 –∏–ª–∏ 3

                var to_start = getMomentNowTime().diff(start, 'minutes');
                if( Math.abs(to_start) < 10 ){
                    // –µ—Å–ª–∏ –¥–æ —Å—Ç–∞—Ä—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å 10 –º–∏–Ω—É—Ç —Ç–æ —Å–∫–æ—Ä–æ —Ä–∞–∑–≤–æ–¥–∏—Ç—Å—è
                    result.status = 1;
                    result.time_obj = time_obj;
                    result.comment = i18.will_close(to_start)[app_language];
                    return false;
                }else{
                    // result = 0
                    return true;
                }
            }

        });

        return result;

    }

    function checkTime_color(number){
        // 0 —Å–≤–µ–¥—ë–Ω
        // 1 —Å–∫–æ—Ä–æ —Ä–∞–∑–≤–µ–¥—ë—Ç—Å—è
        // 2 —Ä–∞–∑–≤–µ–¥—ë–Ω
        // 3 —Å–∫–æ—Ä–æ —Å–≤–µ–¥—ë—Ç—Å—è
        switch (number) {
            case 0:
                return "#01bb2a";
            case 1:
                return "#e7e406";
            case 2:
                return "#bb0000";
            case 3:
                return "#fe9f00";
        }
    }


    var navigator_language = window.navigator.language;
    var app_language = "ru";
    if( navigator_language ){
        if( navigator_language.includes("ru") ){
            setLanguage("ru")
        }else if(navigator_language.includes("en")){
            setLanguage("en")
        }else if( navigator_language.includes("zh") ){
            setLanguage("ch")
        }
    }

    function setLanguage(lang_string){
        app_language = lang_string;
        setGeoJSON()
        generateUlist()
    }


    var animate_is_active = 0;
    var animate_timer = 0;
    function getMomentNowTime() {
        if( animate_is_active ){
            return moment().hour(1).minute( animate_is_active )
        }

        return moment(Time);
    }


    function animating() {

        if ( animate_is_active > 0 ){
            clearInterval(animate_timer)
            animate_is_active = 0;
            setGeoJSON()
        }else{
            animate_is_active = 1;
            animate_timer = setInterval(function(){
                ++animate_is_active;
                setGeoJSON()
            }, 500)
        }


    }

</script>
</body>
</html>